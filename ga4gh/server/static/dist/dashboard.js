"use strict";$(window).on("load",function(){makeRequest("datasets/search",{}).then(function(a){const b=JSON.parse(a),c=b.results.datasets;let d=document.getElementById("dropdown-menu");for(let b=0;b<c.length;b++)finalDatasetId.includes(c[b].id)||(finalDatasetId.push(c[b].id),finalDatasetName.push(c[b].name));for(let b=0;b<finalDatasetId.length;b++)d.innerHTML+="<a class=\"dropdown-item\" id=\"refresh\" href=\"javascript:void(0)\" onclick=\"refreshDataset("+b+")\">"+finalDatasetName[b]+"</a>";if(null==getCookie("datasetId")?(datasetId=finalDatasetId[0],$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[0])):(datasetId=getCookie("datasetId"),$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[finalDatasetId.indexOf(getCookie("datasetId"))])),"/"==location.pathname){let a=new dashboard;a.initialize()}},function(){document.getElementById("tab-content").style.display="none",alertBuilder("No data currently available. Please contact a system administrator for assistance.")})});function refreshDataset(a){datasetId=finalDatasetId[a],document.getElementById("warningMsg").style.display="none",setCookie("datasetId",datasetId),$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[finalDatasetId.indexOf(getCookie("datasetId"))]);let b=new dashboard;b.initialize()}function dashboard(){function a(){document.getElementById("responseToTreatment").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("therapeuticToResponses").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("cancerTypes").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("drugScatter").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("hospitals").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("queryStatus").innerHTML="<div class=\"loader_bar\"></div>",document.getElementById("timelineSamples").innerHTML="<div class=\"loader_bar\"></div>"}function b(){document.getElementById("responseToTreatment").innerHTML="<p class='noPermission'>You don't have access to this data.</p>",document.getElementById("therapeuticToResponses").innerHTML="<p class='noPermission'>You don't have access to this data.</p>",document.getElementById("cancerTypes").innerHTML="<p class='noPermission'>You don't have access to this data.</p>",document.getElementById("drugScatter").innerHTML="<p class='noPermission'>You don't have access to this data.</p>",document.getElementById("hospitals").innerHTML="<p class='noPermission'>You don't have access to this data.</p>"}function c(a,b){for(var c={},d=[],e=0;e<a.length;e++)c={},c.name=a[e],c.y=b[e],d.push(c);return d}function d(a){k("responseToTreatment","bar","Response to treatments",groupBy(a,"responseToTreatment")),k("therapeuticToResponses","bar","Therapeutic Types",groupBy(a,"therapeuticModality"))}function e(){makeRequest("samples/search",{datasetId:datasetId}).then(function(a){var b,c=JSON.parse(a),d=c.results.samples,e=[];if(null!=d[0].collectionHospital&&(b=groupBy(d,"collectionHospital"),k("hospitals","bar","Hospital distribution",b)),null==d[0].collectionDate)document.getElementById("timelineSamples").innerHTML="<p class='noPermission'>You don't have access to this data.</p>";else{for(var g=0;g<d.length;g++)if(d[g].collectionDate){var h=d[g].collectionDate;d[g].collectionDate=h.substr(h.length-4)}e=groupBy(d,"collectionDate");var j=Object.keys(e),l=Object.values(e),m=[0];l.forEach(function(a,b){var c=m[b]+a;m.push(c)}),m.shift(),f(l,j,m)}})}function f(a,b,c){Highcharts.chart("timelineSamples",{chart:{type:"area",zoomType:"xy"},title:{text:"Samples received by years"},credits:{enabled:!1},exporting:{enabled:!1},xAxis:{categories:b,tickmarkPlacement:"on",title:{enabled:!1}},yAxis:{title:{text:""},labels:{formatter:function(){return this.value}}},tooltip:{split:!0,valueSuffix:""},plotOptions:{area:{stacking:"normal",lineColor:"#666666",lineWidth:1,marker:{lineWidth:1,lineColor:"#666666"}}},series:[{type:"column",name:"new sample",data:a},{type:"line",name:"Cumulative samples",data:c}]})}function g(a,b,c,d,e){Highcharts.chart(a,{chart:{type:"bar"},title:{text:b},credits:{enabled:!1},exporting:{enabled:!1},xAxis:{type:"category"},legend:{enabled:!1},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0}}},series:[{type:"pie",name:c,colorByPoint:!0,data:d,cursor:"pointer",point:{events:{click:function(){j(e,this.name)}}}}]})}function h(){makeRequest("diagnoses/search",{datasetId:datasetId}).then(function(a){for(var b=Math.floor,c=JSON.parse(a),d=c.results.diagnoses,e=[],f={},h={},k=[],m=0;m<d.length;m++)d[m].cancerType&&d[m].patientId&&k.push(d[m]);var n=k.map(a=>Object.assign(a,l.find(b=>b.patientId==a.patientId)));for(let c,d=0;d<n.length;d++)if(c=n[d],c.drugListOrAgent&&c.startDate&&c.stopDate){let a=new Date(c.startDate),d=new Date(c.stopDate),e=b((d-a)/86400000),f=c.drugListOrAgent.split(", ");for(let a=0;a<f.length;a++)h[c.cancerType]||(h[c.cancerType]={}),h[c.cancerType][f[a]]||(h[c.cancerType][f[a]]=[]),h[c.cancerType][f[a]].push(e)}var o=Object.keys(h);let p=b(Math.random()*o.length),q=o[p];j(h,q);for(var r=groupBy(d,"cancerType"),s=Object.keys(r),t=Object.values(r),m=0;m<s.length;m++)f={},f.name=s[m],f.y=t[m],f.drilldown=s[m],e.push(f);g("cancerTypes","cancer types and corresponding treatment drugs","cancer types",e,h)})}function j(a,b){let c=Object.keys(a[b]),d=[];for(var e=0;e<c.length;e++){let g;for(var f=0;f<a[b][c[e]].length;f++)g=[],g.push(e),g.push(a[b][c[e]][f]),d.push(g)}Highcharts.chart("drugScatter",{chart:{renderTo:"drugScatter",type:"scatter",zoomType:"xy"},title:{text:"Time of drug treatment for "+b},credits:{enabled:!1},exporting:{enabled:!1},xAxis:{categories:c},yAxis:{title:{text:"days"}},tooltip:{formatter:function(){return""+this.x+", "+this.y+" days"}},plotOptions:{scatter:{marker:{symbol:"circle",radius:5,states:{hover:{enabled:!0,lineColor:"rgb(100,100,100)"}}},states:{hover:{marker:{enabled:!1}}}}},series:[{name:"Drugs",color:"rgba(223, 83, 83, .75)",data:d}]})}function k(a,b,d,e){var f=Object.keys(e),g=Object.values(e),h=c(f,g);Highcharts.chart(a,{chart:{type:b},credits:{enabled:!1},exporting:{enabled:!1},title:{text:d},xAxis:{type:"category"},legend:{enabled:!1},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0}}},series:[{name:"count",colorByPoint:!0,data:h}]})}var l;this.initialize=function(){alertCloser(),a(),e(),makeRequest("treatments/search",{datasetId:datasetId}).then(function(a){var c=JSON.parse(a),e={"Known Peers":c.status["Known peers"],"Queried Peers":c.status["Queried peers"],"Successful Communications":c.status["Successful communications"]};k("queryStatus","bar","Server status",e),l=c.results.treatments,l[0].responseToTreatment==null?b():(h(),d(l))})}}