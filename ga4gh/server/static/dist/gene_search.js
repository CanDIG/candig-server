"use strict";$(window).on("load",function(){makeRequest("datasets/search",{}).then(function(a){const b=JSON.parse(a),c=b.results.datasets;let d=document.getElementById("dropdown-menu");for(let b=0;b<c.length;b++)finalDatasetId.includes(c[b].id)||(finalDatasetId.push(c[b].id),finalDatasetName.push(c[b].name));for(let b=0;b<finalDatasetId.length;b++)d.innerHTML+="<a class=\"dropdown-item\" id=\"refresh\" href=\"javascript:void(0)\" onclick=\"refreshDataset("+b+")\">"+finalDatasetName[b]+"</a>";null==getCookie("datasetId")||-1==finalDatasetId.indexOf(getCookie("datasetId"))?(datasetId=finalDatasetId[0],setCookie("datasetId",datasetId),$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[0])):(datasetId=getCookie("datasetId"),$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[finalDatasetId.indexOf(datasetId)]))},function(){alertBuilder("No data currently available. Please contact a system administrator for assistance.")})});function refreshDataset(a){datasetId=finalDatasetId[a],document.getElementById("warningMsg").style.display="none",setCookie("datasetId",datasetId),$("#dropdownMenuLink").html("<i class=\"fas fa-database\"></i> "+finalDatasetName[finalDatasetId.indexOf(getCookie("datasetId"))])}var statusCode=0;if($("#firstRG").empty(),$("#secondRG").empty(),$("#igvSample").empty(),document.getElementById("request").value="",document.getElementById("readGroupSelector").style.display="none",document.getElementById("geneTable_wrap").style.display="none",document.getElementById("title").style.marginTop="10%",""!=document.getElementById("geneTable").innerHTML&&-1!=statusCode){var table=$("#geneTable").DataTable();table.destroy(),document.getElementById("geneTable").innerHTML="",statusCode=0}document.getElementById("searchBtn").addEventListener("click",submit),document.getElementById("confirmRG").addEventListener("click",rg_submit);function submit(){if($("#firstRG").empty(),$("#secondRG").empty(),$("#igvSample").empty(),1==statusCode&&""!=document.getElementById("geneTable").innerHTML){var a=$("#geneTable").DataTable();a.destroy(),document.getElementById("geneTable").innerHTML=""}document.getElementById("loader").style.display="block",document.getElementById("geneTable").innerHTML="",document.getElementById("readGroupSelector").style.display="none";var b=document.getElementById("request").value,c={datasetId:datasetId,gene:b};makeRequest("/variantsbygenesearch",c).then(function(a){var c=JSON.parse(a),d=c.results.variants;tableMaker(d),readGroupFetcher(b,d),document.getElementById("igvSample").style.display="block",statusCode=1},function(){document.getElementById("loader").style.display="none",document.getElementById("igvSample").style.display="none",document.getElementById("geneTable").innerHTML="Sorry, but we are not able to locate the gene.",statusCode=-1})}function freqCounter(a){result={};for(var b=0;b<a.length;b++)result[a[b]]||(result[a[b]]=0),++result[a[b]];return result}let readGroupDict={};function readGroupFetcher(a,b){makeRequest("readgroupsets/search",{datasetId:datasetId}).then(function(c){var d=JSON.parse(c),e=[],f=[];try{let c,h=d.results.readGroupSets,j=[],k=[];for(let a=0;a<h.length;a++)j.push(h[a].id),e.push(h[a].readGroups[0].id),f.push(h[a].readGroups[0].referenceSetId),k.push(h[a].name);for(var g=0;1>g;g++){let a=b[g],d=a.referenceName;d.includes("chr")?c=d.replace("chr",""):parseInt(d)==NaN?alertBuilder("We are sorry, but some parts of IGV may not work correctly."):c=d}readGroupDict.geneRequest=a,readGroupDict.referenceSetIds=f[0],readGroupDict.chromesomeId=c,readGroupDict.readGroupIds=e,readGroupDict.readGroupSetId=j,readGroupDict.readGroupName=k;let l=document.getElementById("firstRG"),m=document.getElementById("secondRG");for(let a=0;a<j.length;a++)l.options[l.options.length]=new Option(k[a],j[a]),m.options[m.options.length]=new Option(k[a],j[a]);document.getElementById("readGroupSelector").style.display="block"}catch(a){alertBuilder("We are sorry, but the IGV browser cannot be rendered.")}},function(){alertBuilder("We are sorry, but the IGV browser cannot be rendered.")})}function rg_submit(){var a;try{let b=document.getElementById("firstRG").value,c=document.getElementById("secondRG").value;a=b==c?"":{sourceType:"ga4gh",type:"alignment",url:prepend_path+"",referenceId:"",readGroupIds:"",readGroupSetIds:"",name:""};let d=readGroupDict.readGroupIds[readGroupDict.readGroupSetId.indexOf(b)],e=readGroupDict.readGroupName[readGroupDict.readGroupSetId.indexOf(b)],f=readGroupDict.readGroupIds[readGroupDict.readGroupSetId.indexOf(c)],g=readGroupDict.readGroupName[readGroupDict.readGroupSetId.indexOf(c)];""!=a&&(a.readGroupIds=f,a.readGroupSetIds=c,a.name=g),referenceIdFetcher(readGroupDict.geneRequest,readGroupDict.referenceSetIds,{readGroupSetId:b,readGroupIds:d,name:e},a,readGroupDict.chromesomeId)}catch(a){console.log("we are having problems fetching info")}}function referenceIdFetcher(a,b,c,d,e){makeRequest("references/search",{referenceSetId:b}).then(function(f){let g=JSON.parse(f),h="";try{let f=g.results.references;for(let a=0;a<f.length;a++)f[a].name==e&&(h=f[a].id);""!=d&&(d.referenceId=h),variantSetIdFetcher(a,b,c,d,h,e)}catch(a){alertBuilder("We are sorry, but some parts of IGV may not work correctly.")}},function(){alertBuilder("We are sorry, but some parts of IGV may not work correctly.")})}function variantSetIdFetcher(a,b,c,d,e,f){makeRequest("variantsets/search",{datasetId:datasetId}).then(function(g){let h,i=JSON.parse(g);i.results.variantSets[0].id!=null&&(h=i.results.variantSets[0].id,igvSearch(h,a,b,c,d,e,f))})}function igvSearch(a,b,c,d,e,f,g){var h=document.getElementById("igvSample"),i={locus:b,genome:"hg19",reference:{id:"hg19",fastaURL:"https://s3.amazonaws.com/igv.broadinstitute.org/genomes/seq/1kg_v37/human_g1k_v37_decoy.fasta",cytobandURL:"https://s3.amazonaws.com/igv.broadinstitute.org/genomes/seq/b37/b37_cytoband.txt"},oauthToken:session_id,showRuler:!0,tracks:[{sourceType:"ga4gh",type:"variant",url:prepend_path+"",referenceName:g,variantSetId:a,name:"Variants",pageSize:1e4,visibilityWindow:1e5},{sourceType:"ga4gh",type:"alignment",url:prepend_path+"",referenceId:f,readGroupIds:d.readGroupIds,readGroupSetIds:d.readGroupSetId,name:d.name},e,{name:"Genes",type:"annotation",format:"bed",sourceType:"file",url:"https://s3.amazonaws.com/igv.broadinstitute.org/annotations/hg19/genes/refGene.hg19.bed.gz",indexURL:"https://s3.amazonaws.com/igv.broadinstitute.org/annotations/hg19/genes/refGene.hg19.bed.gz.tbi",order:Number.MAX_VALUE,visibilityWindow:3e8,displayMode:"EXPANDED",height:300}]};""==e&&i.tracks.splice(2,1);igv.createBrowser(h,i)}function tableMaker(a){var b,c,d,e=$("<table/>").attr("id","geneTable"),f={};$("#geneTable").append("<thead><tr><th scope=\"col\" >Reference Name</th><th scope=\"col\">Start</th><th scope=\"col\">End</th> <th scope=\"col\">Length</th><th scope=\"col\">Reference Bases</th><th scope=\"col\">Alternate Bases</th><th scope=\"col\">Frequency</th><th scope=\"col\">Names</th></tr></thead><tbody>");for(var g=[],h=0;h<a.length;h++){var k=a[h],l={referenceName:k.referenceName,start:k.start,end:k.end,referenceBases:k.referenceBases,alternateBases:k.alternateBases,names:k.names};g.push(JSON.stringify(l))}for(var h=0;h<g.length;h++)f[g[h]]||(f[g[h]]=0),++f[g[h]];for(var m=Object.keys(f),n=Object.values(f),o=0;o<m.length;o++){var p=JSON.parse(m[o]),c=p.referenceName;d=c.includes("chr")?c.replace("chr","Chromosome "):"Chromosome "+c;var q="<td scope=\"col\">"+d+"</td>",r="<td scope=\"col\">"+p.start+"</td>",s=p.end-p.start,t="<td scope=\"col\">"+p.end+"</td>",u="<td scope=\"col\">"+p.referenceBases+"</td>",v="<td scope=\"col\">"+p.alternateBases+"</td>",w="<td scope=\"col\">"+n[o].toString()+"</td>";if(p.names!=null){b="";for(var h=0;h<p.names.length;h++)p.names[h].includes("rs")?(0<h&&(b+=", "),b+="<a href=\"https://www.ncbi.nlm.nih.gov/SNP/snp_ref.cgi?rs="+p.names[h]+"\">"+p.names[h]+"</a>"):p.names[h].includes("COSM")?(0<h&&(b+=", "),b+="<a href=\"https://cancer.sanger.ac.uk/cosmic/mutation/overview?id="+p.names[h].split("COSM")[1]+"\">"+p.names[h]+"</a>"):(0<h&&(b+=", "),b+=", "+p.names[h])}else b="Not Found";var x="<td scope=\"col\">"+b+"</td>";$("#geneTable").append("<tr>"+q+r+t+("<td scope=\"col\">"+s+"</td>")+u+v+w+x+"</tr>")}$("#geneTable").append("</tbody>"),$(document).ready(function(){$("#geneTable").DataTable(),document.getElementById("geneTable_info").innerHTML+=", aggregated from "+a.length+" records."}),document.getElementById("geneTable_wrap").style.display="block",document.getElementById("title").style.marginTop="50px",document.getElementById("loader").style.display="none"}