sudo: false

matrix:
  include:
  - python: "3.6"
    if: branch != integration_testing
    language: python
    cache:
      directories:
        - $HOME/.cache/pip
        - /tmp/proto3.3.2
    install:
      - pip install pip --upgrade
    # RDFLib requres html5lib;  html5lib requires setuptools version 18.5 or above;
      - pip install -U setuptools
      - easy_install distribute
      - pip install --upgrade distribute
      - python setup.py sdist
      - pip install dist/candig*.tar.gz -c constraints.txt
    # every installable in setup.py's entry_points should be tested here
      - candig_configtest --version
      - candig_server --version
      - candig_repo --version
    before_script:
      - pip install -r dev-requirements.txt
      - python scripts/build_test_data.py
      - ingest --version
      - ingest tests/data/registry.db dataset1 tests/data/sample_clin_metadata.json
      - ingest tests/data/registry.db dataset1 tests/data/sample_pipe_metadata.json
    before_install:
      - bash tools/travis-install-protoc.sh 3.3.2
      - export PATH=/tmp/proto3.3.2/bin:$PATH
    # run_tests.py runs everything under the script: tag so only put commands
    # under it that we want to run (and want to be able to run) as local tests
    script:
      - flake8 configtest_dev.py convert_error_code.py
           repo_dev.py server_dev.py
           setup.py
           tests candig scripts
      - python -mnose tests
              --with-coverage --cover-package candig.server
              --cover-inclusive --cover-min-percentage 75
              --cover-branches --cover-erase
      - make clean -C docs
      - make -C docs
    after_success:
      # run codecov
      - bash <(curl -s https://codecov.io/bash)
  - service: docker
    language: python
    python: 3.6
    env:
      - DOCKER_COMPOSE_VERSION=1.4.2
      - COMPOSE_DIR=/tmp/compose
      - IMAGE_NAME=c3genomics/candig_server
    before_install:
      - sudo rm /usr/local/bin/docker-compose
      - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
      - chmod +x docker-compose
      - sudo mv docker-compose /usr/local/bin
      - mkdir -p ${COMPOSE_DIR}
      - curl -L https://api.github.com/repos/CanDIG/candig_compose/tarball/v1.0.0 | tar
          --strip-components=1  -zxvf - -C ${COMPOSE_DIR}
      - curl -L https://github.com/CanDIG/candig_compose/release/download/v1.0.0
      - cd ${TRAVIS_BUILD_DIR}
      - docker build --pull --tag  ${IMAGE_NAME} .
    install:
      - cd ${COMPOSE_DIR}
      - ./create_compose.sh -o ${TRAVIS_BUILD_DIR}/tests/integrations/compose_config
      - docker-compose -f yml/containers_network.yml -f yml/volumes.yml up -d
      - sleep 8
      - ./candig_setup.sh -o ${TRAVIS_BUILD_DIR}/tests/integrations/compose_config -k localhost:8081 -t localhost
    before_script: echo smething!
    script:
      - cd ${TRAVIS_BUILD_DIR}
      - echo I GET HERE YE

